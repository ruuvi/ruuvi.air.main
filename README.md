# Ruuvi Air Firmware

## IO pins for devkit

nRF52840-DK is used for development.
Use external power supply for the SEN66 sensor (and other I2C sensors),
these sensors should be powered by 3.3V.
Also use additional capacitor for power supply lines (100 uF, 16V), connect it as close as possible to SEN66.
And use additional 3.3 kOhm pull-up resistors for I2C lines (pull-up to +3.3V external power).

### Sensirion SEN66

| nRF52840-DK | Function | SEN66      | Comment        |
|-------------|----------|------------|----------------|
|             | VDD      | 1 (White)  | 3.3V (ext pwr) |
|             | GND      | 2 (Blue)   |                |
| P4:P0.26    | SDA      | 3 (Green)  |                |
| P4:P0.27    | SCL      | 4 (Yellow) |                |
|             | -        | 5          | Not connected  |
|             | -        | 6          | Not connected  |

### Sensirion SHTC3

| nRF52840-DK | Function | SHTC3      | Comment        |
|-------------|----------|------------|----------------|
|             | VDD      | 1 (Red)    | 3.3V (ext pwr) |
|             | GND      | 2 (Black)  |                |
| P4:P0.26    | SDA      | 3 (Green)  |                |
| P4:P0.27    | SCL      | 4 (Yellow) |                |

### Infineon DPS310

| nRF52840-DK | Function | DPS310     | Comment        |
|-------------|----------|------------|----------------|
|             | GND      | 1 (Black)  |                |
|             | VDD      | 2 (Red)    | 3.3V (ext pwr) |
| P4:P0.26    | SDA      | 3 (White)  |                |
| P4:P0.27    | SCL      | 4 (Yellow) |                |

### Texas Instruments OPT4060

| nRF52840-DK | Function | OPT4060 | Comment        |
|-------------|----------|---------|----------------|
|             | VDD      |    1    | 3.3V (ext pwr) |
| GND         | ADDR     |    2    |                |
|             | NC       |    3    | Not connected  |
| GND         | GND      |    4    |                |
| P4:P0.27    | SCL      |    5    |                |
|             | NC       |    6    | Not connected  |
| P3:P1.07    | INT      |    7    |                |
| P4:P0.26    | SDA      |    8    |                |


## Prerequisites for Unity tests:
```bash
sudo apt install ruby
```

## Install nRF Command Line Tools
Download [nRF Command Line Tools](https://www.nordicsemi.com/Products/Development-tools/nrf-command-line-tools)
```bash
sudo dpkg -i nrf-command-line-tools_10.24.2_amd64.deb
sudo apt install /opt/nrf-command-line-tools/share/JLink_Linux_V794e_x86_64.deb --fix-broken
```

## Install nRF Connect SDK
[Installing the nRF Connect SDK](https://docs.nordicsemi.com/bundle/ncs-latest/page/nrf/installation/install_ncs.html)
By default it should be installed in `~/ncs`
Download [nRF Util](https://www.nordicsemi.com/Products/Development-tools/nrf-util)
```bash
chmod +x nrfutil
sudo mv nrfutil /usr/local/bin/
nrfutil upgrade
nrfutil install nrf5sdk-tools
nrfutil install device
nrfutil install completion
nrfutil completion install bash
nrfutil install toolchain-manager
nrfutil toolchain-manager search
nrfutil toolchain-manager install --ncs-version v2.9.2
```
Get nRF Connect SDK (this will clone [sdk-nrf](https://github.com/nrfconnect/sdk-nrf) into `nrf`)
```bash
cd ~/ncs
nrfutil toolchain-manager launch --ncs-version v2.9.2 --shell
west init -m https://github.com/nrfconnect/sdk-nrf --mr v2.9.2 v2.9.2
cd ~/ncs/v2.9.2
west update
west zephyr-export
```

## Clone this repository
```bash
cd ~/ncs/v2.9.2
git clone --recurse-submodules --remote-submodules https://github.com/ruuvi/ruuvi.air.main.git
```

## Run nRF toolchain shell
To run `west` or `twister` commands, you need to run nRF toolchain shell:
```bash
nrfutil toolchain-manager launch --shell
```

## How to build and flash

### Build release version
```bash
./build_ruuviair_a3_release-dev.sh
west flash -d build_ruuviair_a3_release-dev
```

```bash
./build_nrf52840dk_a2_release-dev.sh
west flash -d build_nrf52840dk_a2_release-dev
```

### Build release version with emulated sensor data
```bash
./build_nrf52840dk_a2_release_mock-dev.sh
west flash -d build_nrf52840dk_a2_release_mock-dev
```

### Using `nrfjprog` to flash firmware
First time (or after unsuccessful flashing attempt) you need to reset `nRF52840-DK` with the following command:
```bash
nrfjprog --recover && nrfjprog --pinresetenable && nrfjprog --reset && nrfjprog --pinreset && nrfjprog --recover
```
Erase all internal and external flash memory on nRF52840-DK:
```bash
nrfjprog -f nrf52 --eraseall --qspieraseall
```
Erase all internal and external flash memory on RuuviAir:
```bash
nrfjprog -f nrf52 --config "./nrfjprog_cfg_ruuviair.toml" --eraseall --qspieraseall
```

#### Flash pre-built binaris generated by GitHub Action to extrenal flash and to internal flash:
##### Flash RuuviAir:
```bash
nrfjprog --recover && nrfjprog --pinresetenable && nrfjprog --reset && nrfjprog --pinreset && nrfjprog --recover
nrfjprog -f nrf52 --memwr 0x50000720 --val 0x00000004
nrfjprog -f nrf52 --config "./nrfjprog_cfg_ruuviair.toml" --qspieraseall
nrfjprog -f nrf52 --config "./nrfjprog_cfg_ruuviair.toml" --program "./build_ruuviair_a3_release-dev/merged.ext_flash.hex" --qspisectorerase --verify
nrfjprog -f nrf52 --program "./build_ruuviair_a3_release-prod/merged.hex" --chiperase --verify --hardreset
nrfjprog -f nrf52 --rbp ALL
```
**Note:** After `nrfjprog --recover` we need to wait for 5 seconds until watchdog is triggered or execute `nrfjprog --pinresetenable && nrfjprog --reset && nrfjprog --pinreset && nrfjprog --recover`.

##### Flash nRF52840-DK:
```bash
nrfjprog -f nrf52 --program "./build_nrf52840dk_a2_release-dev/merged.ext_flash.hex" --qspisectorerase --verify
nrfjprog -f nrf52 --program "./build_nrf52840dk_a2_release-dev/b0_container.hex" --chiperase --verify --hardreset
```
To recover firmware from the external flash memory:
* Press and hold the PINHOLE button (BUTTON1 on nRF52840-DK).
* Press reset button.
* Hold the PINHOLE button for 10 second (while Green LED is flashing once per second).
* After 10 seconds the Green LED should stop blinking and light up steadily - this means that the firmware recovery process has started.
* Wait 30-40 seconds for the firmware to restore, then the device should reboot automatically.


#### How to flash whole project including bootloaders using 'nrfjprog'
##### Flash RuuviAir:
```bash
nrfjprog --recover && nrfjprog --pinresetenable && nrfjprog --reset && nrfjprog --pinreset && nrfjprog --recover
nrfjprog -f nrf52 --config "./nrfjprog_cfg_ruuviair.toml" --program "./build_ruuviair_a3_release-dev/merged.hex" --chiperase --verify --hardreset
```
##### Flash nRF52840-DK:
```bash
nrfjprog -f nrf52 --program "./build_nrf52840dk_a2_release-dev/merged.hex" --chiperase --verify --hardreset
```

#### Flash pre-built binary generated by GitHub Action:
##### Flash RuuviAir:
```bash
nrfjprog --recover && nrfjprog --pinresetenable && nrfjprog --reset && nrfjprog --pinreset && nrfjprog --recover
nrfjprog -f nrf52 --config "./nrfjprog_cfg_ruuviair.toml" --program "./build_ruuviair_a3_release-prod/merged.hex" --chiperase --verify --hardreset
```
##### Flash nRF52840-DK:
```bash
nrfjprog -f nrf52 --program "./build_nrf52840dk_a2_release-dev/merged.hex" --chiperase --verify --hardreset
```

#### Flash pre-built binary with emulated sensor data generated by GitHub Action:
```bash
nrfjprog -f nrf52 --program "./build_nrf52840dk_a2_release_mock-dev/merged.hex" --chiperase --verify --hardreset
```


## Get logs from UART
```bash
minicom -b 115200 -D /dev/ttyACM0
```
Press reset button on the board to see logs.


## Troubleshoot problem with `twister`
If `twister` fails with the error: `ImportError: libffi.so.7: cannot open shared object file: No such file or directory`
Then to resolve this issue, you need to install the missing `libffi` library.
Here are the steps you can follow:
If `libffi7` is not available in your current repositories, you can manually download and install it:
```bash
wget http://archive.ubuntu.com/ubuntu/pool/main/libf/libffi/libffi7_3.3-4_amd64.deb
sudo dpkg -i libffi7_3.3-4_amd64.deb
```
You can check if `libffi.so.7` exists by:
```bash
ls -l /usr/lib/x86_64-linux-gnu/libffi.so.7
```

Install the 32-bit libraries required for building unit-tests for 'native_sim' target
Otherwise, the build will fail with the error: `/usr/include/stdint.h:26:10: fatal error: bits/libc-header-start.h: No such file or directory`
```bash
sudo apt-get install gcc-multilib
```


## How to run tests using `twister`
### Run all tests on computer
```bash
nrfutil toolchain-manager launch --shell
twister -c -p native_sim -v -T .
# or
twister -c -p native_sim -v -T . --inline-logs
```

### Run all tests on computer (x64)
```bash
nrfutil toolchain-manager launch --shell
twister -c -p native_sim/native/64 -v -T .
# or
twister -c -p native_sim/native/64 -v -T . --inline-logs
```

### Run specific test on computer
```bash
nrfutil toolchain-manager launch --shell
twister -c -p native_sim -v -T tests/unity/test_example1
twister -c -p native_sim -v -T tests/ztest/test_example2
```

### Run all tests on nRF52840DK
```bash
nrfutil toolchain-manager launch --shell
twister -c -p nrf52840dk/nrf52840 -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_nrf52840dk.overlay;$PWD/dts_common.overlay" -v --device-testing --device-serial /dev/ttyACM0 --west-flash -T .
```

### Run all tests on RuuviAir
```bash
nrfutil toolchain-manager launch --shell
twister -c --board-root $PWD/boards -x=BOARD_ROOT=$PWD -p ruuvi_ruuviair/nrf52840 \
    -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_ruuviair.overlay;$PWD/dts_common.overlay" -v \
    --device-testing --device-serial /dev/ttyACM0 --west-flash -T .
```

### Run specific test on nRF52840DK
```bash
nrfutil toolchain-manager launch --shell
twister -c -p nrf52840dk/nrf52840 -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_nrf52840dk.overlay;$PWD/dts_common.overlay" -v --device-testing --device-serial /dev/ttyACM0 --west-flash -T tests/unity/test_example1
twister -c -p nrf52840dk/nrf52840 -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_nrf52840dk.overlay;$PWD/dts_common.overlay" -v --device-testing --device-serial /dev/ttyACM0 --west-flash -T tests/ztest/test_example2
twister -c -p nrf52840dk/nrf52840 -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_nrf52840dk.overlay;$PWD/dts_common.overlay" -v --device-testing --device-serial /dev/ttyACM0 --west-flash -T tests/ztest/test_led
twister -c -p nrf52840dk/nrf52840 -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_nrf52840dk.overlay;$PWD/dts_common.overlay" -v --device-testing --device-serial /dev/ttyACM0 --west-flash -T tests/ztest/test_dsp
```

### Run specific test on RuuviAir
```bash
nrfutil toolchain-manager launch --shell
twister -c --board-root $PWD/boards -x=BOARD_ROOT=$PWD -p ruuvi_ruuviair/nrf52840 \
    -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_ruuviair.overlay;$PWD/dts_common.overlay" -v \
    --device-testing --device-serial /dev/ttyACM0 --west-flash -T tests/unity/test_example1
twister -c --board-root $PWD/boards -x=BOARD_ROOT=$PWD -p ruuvi_ruuviair/nrf52840 \
    -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_ruuviair.overlay;$PWD/dts_common.overlay" -v \
    --device-testing --device-serial /dev/ttyACM0 --west-flash -T tests/ztest/test_example2
twister -c --board-root $PWD/boards -x=BOARD_ROOT=$PWD -p ruuvi_ruuviair/nrf52840 \
    -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_ruuviair.overlay;$PWD/dts_common.overlay" -v \--device-testing --device-serial /dev/ttyACM0 --west-flash -T tests/ztest/test_led
twister -c --board-root $PWD/boards -x=BOARD_ROOT=$PWD -p ruuvi_ruuviair/nrf52840 \
    -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_ruuviair.overlay;$PWD/dts_common.overlay" -v \
    --device-testing --device-serial /dev/ttyACM0 --west-flash -T tests/ztest/test_dsp
```

### Build all tests without executin for nRF52840DK
```bash
nrfutil toolchain-manager launch --shell
twister -c -p nrf52840dk/nrf52840 -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_nrf52840dk.overlay;$PWD/dts_common.overlay" -v -T .
```

### Build all tests without executin for RuuviAir
```bash
nrfutil toolchain-manager launch --shell
twister -c --board-root $PWD/boards -x=BOARD_ROOT=$PWD -p ruuvi_ruuviair/nrf52840 \
    -x=EXTRA_DTC_OVERLAY_FILE="$PWD/dts_ruuviair.overlay;$PWD/dts_common.overlay" -v -T .
```

## How to build and run tests using `west`

### How to build and run tests using `west` on computer
```bash
nrfutil toolchain-manager launch --shell
cd tests/ztest/test_example2
west build -b native_sim . -d build_native_sim
./build_native_sim/zephyr/zephyr.exe
```

### How to build and run tests using `west` on nRF52840DK
```bash
nrfutil toolchain-manager launch --shell
cd tests/ztest/test_led
west build -b nrf52840dk_nrf52840 . -d build_nrf52840dk \
    -DEXTRA_DTC_OVERLAY_FILE="$PWD/../../../dts_nrf52840dk.overlay;$PWD/../../../dts_common.overlay"
west flash -d build_nrf52840dk
```

### How to build and run tests using `west` on RuuviAir
```bash
nrfutil toolchain-manager launch --shell
cd tests/ztest/test_led
west build -b ruuvi_ruuviair/nrf52840 . -d build_ruuviair \
    -DEXTRA_DTC_OVERLAY_FILE="$PWD/../../../dts_ruuviair.overlay;$PWD/../../../dts_common.overlay" \
    -DBOARD_ROOT=$PWD/../../..
west flash -d build_ruuviair
```

### How to activate firmware_loader from the second-stage MCUboot bootloader
* Press and hold pinhole button for 5 seconds (BUTTON1 on nRF52850-DK / PCA10056)
* Or instead of waiting for 5 seconds, press RESET button or power on device
* Wait 1 second until Red LED (LED2 on nRF52850-DK) lights up brightly
* Release the pinhole button (BUTTON1)
* Wait until firmware_loader is started

## How to run `VS Code`
```bash
source ~/ncs/zephyr/zephyr-env.sh
nrfutil toolchain-manager launch --shell
code
```

## Generating signauture keys

See official docs here: [B0/MCUboot bootloader signature keys](https://docs.nordicsemi.com/bundle/ncs-latest/page/nrf/app_dev/bootloaders_dfu/mcuboot_nsib/bootloader_signature_keys.html)

### Example of using different tools to generate signature keys
#### Using Imgtool to generate keys
```bash
python3 bootloader/mcuboot/scripts/imgtool.py keygen -t ecdsa-p256 -k priv.pem
python3 bootloader/mcuboot/scripts/imgtool.py getpub -k priv.pem -e pem -o public.pem
```

#### Using OpenSSL to generate keys
```bash
openssl ecparam -name prime256v1 -genkey -noout -out priv.pem
openssl ec -in priv.pem -pubout -out public.pem
```

### Generating development signature keys
```bash
cd ~/ncs/v2.9.2
mkdir -p ~/.signing_keys
python3 bootloader/mcuboot/scripts/imgtool.py keygen -t ecdsa-p256 -k ~/.signing_keys/b0_sign_key_private-dev.pem
python3 bootloader/mcuboot/scripts/imgtool.py keygen -t ecdsa-p256 -k ~/.signing_keys/image_sign-dev.pem
```

### Generating production signature keys
```bash
cd ~/ncs/v2.9.2
mkdir -p ~/.signing_keys
python3 bootloader/mcuboot/scripts/imgtool.py keygen -t ecdsa-p256 -k ~/.signing_keys/b0_sign_key_private-prod.pem
python3 bootloader/mcuboot/scripts/imgtool.py getpub -k ~/.signing_keys/b0_sign_key_private-prod.pem -e pem -o ~/.signing_keys/b0_sign_key_public-prod.pem
python3 bootloader/mcuboot/scripts/imgtool.py keygen -t ecdsa-p256 -k ~/.signing_keys/image_sign-prod.pem
```

# Ruuvi Air MCUMgr shell commands

RuuviAir contains management subsystem with shell, which supports the following commands.

## Shell command **echo**
Command **echo** prints back the passed parameter.

Format:
```
ruuvi echo <message>
```

Examples:
```
ruuvi echo Hello
ruuvi echo "Hello World"
```

## Shell command **led_brightness**

**led_brightness** command allows to control brightness level of the main LED.

Format:
```
ruuvi led_brightness <off|night|day|bright_day|0-100%|0.0-100.0%>
```

Examples:
```
ruuvi led_brightness off
ruuvi led_brightness night
ruuvi led_brightness day
ruuvi led_brightness bright_day
ruuvi led_brightness 25%
ruuvi led_brightness 2.5%>
```

## Shell command **led_write_channels**

**led_write_channels** command is used for testing purposes.
It allows to set raw currents/PWM for the main LED.

Format:
```
ruuvi led_write_channels <Cur_R [0-255]> <Cur_G [0-255]> <Cur_B [0-255]> <PWM_R [0-255]> <PWM_G [0-255]> <PWM_B [0-255]>
```

Examples:
```
ruuvi led_write_channels 250 80 100 128 128 128
```

## Shell command **led_get_color_table**

**led_get_color_table** allows to get the color table for the specified predefined brightness level.

Format:
```
ruuvi led_get_color_table <night|day|bright_day>
```

Examples:
```
ruuvi led_get_color_table night
ruuvi led_get_color_table day
ruuvi led_get_color_table bright_day
```

Format of output:
```
LED color table 'night|day|bright_day': <Current_R, Current_G, Current_B> [<PWM1_R, PWM1_G, PWM1_B> <PWM2_R, PWM2_G, PWM2_B> <PWM3_R, PWM3_G, PWM3_B> <PWM4_R, PWM4_G, PWM4_B> <PWM5_R, PWM5_G, PWM5_B>]
```
PWM1 - for AQI 'Excellent'
PWM2 - for AQI 'Good'
PWM3 - for AQI 'Fair'
PWM4 - for AQI 'Poor'
PWM5 - for AQI 'Very Poor'


Example of output:
```
LED color table 'night': <12, 2, 10> [<0, 255, 90> <30, 255, 0> <240, 255, 0> <255, 80, 0> <255, 0, 0>]
```

## Shell command **led_set_color_table**

**led_set_color_table** allows to set the color table for the specified predefined brightness level.

Format:
```
ruuvi led_set_color_table <night|day|bright_day> <C_R> <C_G> <C_B> <R1> <G1> <B1> <R2> <G2> <B2> <R3> <G3> <B3> <R4> <G4> <B4> <R5> <G5> <B5>
```

Examples:
```
ruuvi led_set_color_table night 12 2 10 0 255 90 30 255 0 240 255 0 255 80 0 255 0 0
```

## Shell command **led_reset_color_table**

**led_reset_color_table** allows to reset the color table for the specified predefined brightness level.

Format:
```
ruuvi led_reset_color_table <night|day|bright_day>
```

Examples:
```
ruuvi led_reset_color_table night
ruuvi led_reset_color_table day
ruuvi led_reset_color_table bright_day
```

## Shell command **version_info**

**version_info** allows to get firmware version info for App/FwLoader/MCUboo0/MCUboo1, hardware revision name and buid type (development or production).

Format:
```
ruuvi version_info
```

Example of output:
```
Hardware revision: RuuviAir-A3
Build type: development
App version: 1.0.7+1
FwLoader version: 1.0.2+21
MCUBoot0 version: 1.0.0+28
MCUBoot1 version: 1.0.0+28
```
