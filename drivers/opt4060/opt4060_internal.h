/**
 * @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.
 */

#ifndef OPT4060_INTERNAL_H_
#define OPT4060_INTERNAL_H_

#include "include/opt4060.h"
#include <stdint.h>
#include <stdbool.h>
#include <zephyr/sys/util.h>
#include <zephyr/drivers/gpio.h>
#include <zephyr/drivers/sensor.h>
#include <zephyr/drivers/i2c.h>

#define OPT4060_MEASURE_MEASUREMENT_DURATION_NUM_CYCLES 10

#define OPT4060_ROUND_HALF_DIVISOR 2

#define OPT4060_TIMEOUT_MARGIN_MULTIPLIER_NUM 4U    /* numerator for 2Ã— timeout margin */
#define OPT4060_TIMEOUT_MARGIN_MULTIPLIER_DEN 2U    /* denominator */
#define OPT4060_TIMEOUT_EXTRA_US              1000U /* guard time to absorb counter jitter */

#if defined(CONFIG_OPT4060_RANGE_AUTO) && CONFIG_OPT4060_RANGE_AUTO
#define OPT4060_REG_CONFIG_DEFAULT_RANGE OPT4060_REG_CONFIG_VAL_RANGE_AUTO
#elif defined(CONFIG_OPT4060_RANGE_2254_LUX) && CONFIG_OPT4060_RANGE_2254_LUX
#define OPT4060_REG_CONFIG_DEFAULT_RANGE OPT4060_REG_CONFIG_VAL_RANGE_2_2_KLUX
#elif defined(CONFIG_OPT4060_RANGE_4509_LUX) && CONFIG_OPT4060_RANGE_4509_LUX
#define OPT4060_REG_CONFIG_DEFAULT_RANGE OPT4060_REG_CONFIG_VAL_RANGE_4_5_KLUX
#elif defined(CONFIG_OPT4060_RANGE_9018_LUX) && CONFIG_OPT4060_RANGE_9018_LUX
#define OPT4060_REG_CONFIG_DEFAULT_RANGE OPT4060_REG_CONFIG_VAL_RANGE_9_KLUX
#elif defined(CONFIG_OPT4060_RANGE_18036_LUX) && CONFIG_OPT4060_RANGE_18036_LUX
#define OPT4060_REG_CONFIG_DEFAULT_RANGE OPT4060_REG_CONFIG_VAL_RANGE_18_KLUX
#elif defined(CONFIG_OPT4060_RANGE_36071_LUX) && CONFIG_OPT4060_RANGE_36071_LUX
#define OPT4060_REG_CONFIG_DEFAULT_RANGE OPT4060_REG_CONFIG_VAL_RANGE_36_KLUX
#elif defined(CONFIG_OPT4060_RANGE_72142_LUX) && CONFIG_OPT4060_RANGE_72142_LUX
#define OPT4060_REG_CONFIG_DEFAULT_RANGE OPT4060_REG_CONFIG_VAL_RANGE_72_KLUX
#elif defined(CONFIG_OPT4060_RANGE_144284_LUX) && CONFIG_OPT4060_RANGE_144284_LUX
#define OPT4060_REG_CONFIG_DEFAULT_RANGE OPT4061_REG_CONFIG_VAL_RANGE_144_KLUX
#else
#error "Unsupported range"
#endif

#if defined(CONFIG_OPT4060_CONV_TIME_600_US) && CONFIG_OPT4060_CONV_TIME_600_US
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_600_US
#elif defined(CONFIG_OPT4060_CONV_TIME_1_MS) && CONFIG_OPT4060_CONV_TIME_1_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_1_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_1_8_MS) && CONFIG_OPT4060_CONV_TIME_1_8_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_1_8_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_3_4_MS) && CONFIG_OPT4060_CONV_TIME_3_4_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_3_4_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_6_5_MS) && CONFIG_OPT4060_CONV_TIME_6_5_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_6_5_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_12_7_MS) && CONFIG_OPT4060_CONV_TIME_12_7_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_12_7_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_25_MS) && CONFIG_OPT4060_CONV_TIME_25_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_25_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_50_MS) && CONFIG_OPT4060_CONV_TIME_50_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_50_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_100_MS) && CONFIG_OPT4060_CONV_TIME_100_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_100_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_200_MS) && CONFIG_OPT4060_CONV_TIME_200_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_200_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_400_MS) && CONFIG_OPT4060_CONV_TIME_400_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_400_MS
#elif defined(CONFIG_OPT4060_CONV_TIME_800_MS) && CONFIG_OPT4060_CONV_TIME_800_MS
#define OPT4060_REG_CONFIG_DEFAULT_CONV_TIME OPT4060_REG_CONFIG_VAL_CONV_TIME_800_MS
#else
#error "Unsupported conversion time"
#endif

typedef struct opt4060_ch_data_t {
	uint8_t exponent;
	opt4060_measurement_cnt_t cnt;
	bool is_valid;
	uint32_t mantissa;
} opt4060_ch_data_t;

typedef struct opt4060_data_t {
	struct opt4060_ch_data_t ch_data[4];
	uint16_t cfg_reg;
#ifdef CONFIG_OPT4060_INT
	const struct device *p_dev;
	struct gpio_callback gpio_int_cb;
#if CONFIG_OPT4060_TRIGGER_DATA_READY
	sensor_trigger_handler_t handler_drdy;
	const struct sensor_trigger *p_trig_drdy;
#endif
#if defined(CONFIG_OPT4060_INT_OWN_THREAD)
	K_KERNEL_STACK_MEMBER(thread_stack, CONFIG_OPT4060_THREAD_STACK_SIZE);
	struct k_thread thread;
	struct k_sem gpio_sem;
#elif defined(CONFIG_OPT4060_INT_GLOBAL_THREAD)
	struct k_work work;
#endif
#endif /* CONFIG_OPT4060_INT */
#if defined(CONFIG_OPT4060_OP_MODE_ONESHOT) && CONFIG_OPT4060_OP_MODE_ONESHOT
	bool flag_one_shot_started;
#else
	int32_t one_measurement_duration_ticks;
	int64_t sensor_channel_get_accum_time;
	int32_t sensor_channel_get_cnt;
	int32_t sensor_channel_get_duration_ticks;
#endif
} opt4060_data_t;

typedef struct opt4060_config_t {
	struct i2c_dt_spec i2c;
#if defined(CONFIG_OPT4060_INT) && CONFIG_OPT4060_INT
	const struct gpio_dt_spec gpio_int;
#endif
} opt4060_config_t;

opt4060_ret_t opt4060_init_interrupt(const struct device *dev);

bool opt4060_read_all_channels(const struct device *const p_dev);

#endif /* OPT4060_INTERNAL_H_ */
